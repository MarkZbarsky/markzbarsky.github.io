<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FSM Adventure Game | Mark Zbarsky</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/media-queries.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="../js/script.js" defer></script>
    <script>
        // Code viewer functionality
        document.addEventListener('DOMContentLoaded', function() {
            const codeFiles = {
                sword_fsm: `//Sword_module
module sword_fsm(
	input logic clk, reset,
	input logic [2:0] curr_room, 
	output logic has_sword
);
typedef enum logic {
NO_SWORD = 1'b0,
HAS_SWORD = 1'b1
} sword_state;

sword_state state, next_state;

//flip flop logic
always_ff @(posedge clk, posedge reset) begin
	if (reset)
		state <= NO_SWORD;
	else
		state <= next_state;
end

//next state logic
always_comb begin
	case (state)
		NO_SWORD: begin
			if (curr_room == 3'b011) //secret stash room
				next_state = HAS_SWORD;
			
			else 
				next_state = NO_SWORD;
		end	
		HAS_SWORD: next_state = HAS_SWORD;
		default: next_state = NO_SWORD;
	endcase
end

assign has_sword = (state == HAS_SWORD);

endmodule`,
                room_fsm: `module room_fsm (
	input logic clk, reset,
	input logic N, S, E, W,
	input logic has_sword,
	output logic [2:0] curr_room,
	output logic WIN, DIE
);

typedef enum logic [2:0] {
CAVE_CACOPHONY = 3'b000,
TWISTY_TUNNEL = 3'b001,
RAPID_RIVER = 3'b010,
SECRET_SWORD = 3'b011,
DRAGON_DEN = 3'b100,
GREVIOUS_GRAVEYARD = 3'b101,
VICTORY_VAULT = 3'b110
} room_state;

room_state state, next_state;

	always_ff @(posedge clk, posedge reset) begin
		if (reset)
			state <= CAVE_CACOPHONY;
		else
			state <= next_state;
	end
	
	always_comb begin
	
		case (state)
			CAVE_CACOPHONY: begin
				if (E) next_state = TWISTY_TUNNEL;
				else next_state = CAVE_CACOPHONY;
			end
			TWISTY_TUNNEL: begin
				if (W) next_state = CAVE_CACOPHONY;
				else if (S) next_state = RAPID_RIVER;
				else next_state = TWISTY_TUNNEL;
			end
			RAPID_RIVER: begin
				if (W) next_state = SECRET_SWORD;
				else if (N) next_state = TWISTY_TUNNEL;
				else if (E) next_state = DRAGON_DEN;
				else next_state = RAPID_RIVER;
			end
			SECRET_SWORD: begin
				if (E) next_state = RAPID_RIVER;
				else next_state = SECRET_SWORD;
			end
			DRAGON_DEN: begin
				if (E) begin
					if (has_sword) next_state = VICTORY_VAULT;
					else next_state = GREVIOUS_GRAVEYARD;
				end
				else next_state = DRAGON_DEN;
			end
			GREVIOUS_GRAVEYARD: next_state = GREVIOUS_GRAVEYARD;		
			VICTORY_VAULT: next_state = VICTORY_VAULT;
	
			default: next_state = CAVE_CACOPHONY;
		endcase
	end
	
	
	assign curr_room = state;
	assign WIN = (state == VICTORY_VAULT);
	assign DIE = (state == GREVIOUS_GRAVEYARD);
endmodule`,
                adventure_game: `module adventure_game(
	input logic clk, reset,
	input logic N, S, E, W,
	output logic WIN, DIE
	);
	
	logic [2:0] curr_room;
	logic has_sword;
	
	room_fsm room (
		.clk(clk),
		.reset(reset),
		.N(N), .S(S), .E(E), .W(W),
		.has_sword(has_sword),
		.curr_room(curr_room),
		.WIN(WIN),
		.DIE(DIE)
	);
	sword_fsm sword (
		.clk(clk),
		.reset(reset),
		.curr_room(curr_room),
		.has_sword(has_sword)
	);
	
endmodule`,
                testbench: `module testbench;
    logic clk = 0;
    logic reset;
    logic N, S, E, W;
    logic WIN, DIE;
    
    // Instantiate DUT
    adventure_game dut (
        .clk(clk),
        .reset(reset), 
        .N(N), .S(S), .E(E), .W(W),
        .WIN(WIN),
        .DIE(DIE)
    );
    
    // Clock generation
    always #5 clk = ~clk;
    
    // Test vectors
    logic [3:0] vectors [0:15]; // N,S,E,W
    int i;
    
    initial begin
        $readmemb("testinputs.tv", vectors);
        
        // Initialize
        reset = 1;
        N = 0; S = 0; E = 0; W = 0;
        repeat(2) @(posedge clk);
        reset = 0;
        
        // Apply test vectors
        for (i = 0; i < 16; i++) begin
            if (vectors[i] === 4'b1111) begin
                // Reset between tests
                reset = 1;
                @(posedge clk);
                reset = 0;
                $display("=== New Test ===");
            end 
				else begin
                {N, S, E, W} = vectors[i];
                @(posedge clk);
                $display("Time %0t: N=%b S=%b E=%b W=%b WIN=%b DIE=%b", 
                         $time, N, S, E, W, WIN, DIE);
            end
            
            if (vectors[i] === 4'bxxxx) break; // End of file
        end
        $finish;
    end
endmodule`,
                testinputs: `// WIN path: E,S,W,E,E 
0010
0100  
0001
0010
0010
1111  // Reset signal
// DIE path: E,S,E,E 
0010
0100
0010
0010
1111  // End marker`
            };

            const codeViewer = document.getElementById('codeViewer');
            const codeFilename = document.getElementById('codeFilename');
            const codeContent = document.getElementById('codeContent');
            const codeCloseBtn = document.getElementById('codeCloseBtn');
            const codeFileButtons = document.querySelectorAll('.code-file-btn');
            
            let currentActiveButton = null;

            function showCode(fileKey, filename, button) {
                // If clicking the same button, toggle off
                if (currentActiveButton === button && codeViewer.classList.contains('active')) {
                    hideCode();
                    return;
                }

                // Remove active class from previous button
                if (currentActiveButton) {
                    currentActiveButton.classList.remove('active');
                }

                // Set new active button
                currentActiveButton = button;
                button.classList.add('active');

                // Update content
                codeFilename.textContent = filename;
                codeContent.textContent = codeFiles[fileKey];
                
                // Show viewer with smooth transition
                codeViewer.classList.add('active');
                
                // Smooth scroll to code viewer
                setTimeout(() => {
                    codeViewer.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 100);
            }

            function hideCode() {
                codeViewer.classList.remove('active');
                if (currentActiveButton) {
                    currentActiveButton.classList.remove('active');
                    currentActiveButton = null;
                }
            }

            // Add click handlers to file buttons
            codeFileButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const fileKey = button.getAttribute('data-file');
                    const filename = button.textContent;
                    showCode(fileKey, filename, button);
                });
            });

            // Add click handler to close button
            codeCloseBtn.addEventListener('click', hideCode);
        });
    </script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="logo">Mark Zbarsky</a>
            <ul class="nav-links">
                <li class="dropdown">
                    <a href="../index.html" class="dropbtn">Projects <i class="dropdown-arrow">▼</i></a>
                    <div class="dropdown-content">
                        <a href="wind-turbine.html">Wind Turbine</a>
                        <a href="line-follower.html">Line Follower</a>
                        <a href="smart-birdfeeder.html">Smart Birdfeeder</a>
                        <a href="pixie-radio.html">Pixie Radio</a>
                        <a href="mips-calculator.html">MIPS Calculator</a>
                        <a href="fsm-adventure-game.html">FSM Adventure Game</a>
                        <a href="home-server.html">Home Server</a>
                        <a href="digit-predictor.html">Handwritten Digit Classifier</a>
                    </div>
                </li>
                <li><a href="../about.html">About</a></li>
            </ul>
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <header class="project-header">
        <div class="container">
            <h1>FSM Adventure Game</h1>
            <p class="project-meta">Digital Design • SystemVerilog • September 2024</p>
        </div>
    </header>

    <main>
        <section class="project-details">
            <div class="container">
                <div class="project-hero">
                    <img src="../images/lab3_waveform.jpg" alt="FSM Adventure Game Waveform">
                </div>
                
                <div class="project-description">
                    <h2>Overview</h2>
                    <p>This was one of my first week-long labs in Computer Hardware Design, designed to introduce finite state machine concepts through an interactive adventure game. The project involved designing two communicating FSMs in SystemVerilog - one tracking the player's location through seven different rooms, and another managing whether the player possesses a sword needed to win the game.</p>
                    
                    <p>While meant to be completed quickly as an educational exercise, this project provided solid foundations in digital design methodology, hardware description languages, and FPGA development using Quartus.</p>

                    <div class="project-gallery two-items">
                        <div class="gallery-item">
                            <img src="../images/lab3states.jpg" alt="Hand-drawn FSM State Diagrams">
                            <p>Hand-drawn state transition diagrams for room and sword FSMs</p>
                        </div>
                        <div class="gallery-item">
                            <img src="../images/multiRoomRTL.PNG" alt="Complete RTL Schematic">
                            <p>Complete RTL schematic generated by Quartus synthesis</p>
                        </div>
                    </div>

                    <h2>System Design</h2>
                    <p>The adventure game consists of two finite state machines that communicate through shared signals. The room FSM handles player navigation through seven locations (Cave of Cacophony, Twisty Tunnel, Rapid River, Secret Sword Stash, Dragon Den, Victory Vault, and Grievous Graveyard), while the sword FSM tracks whether the player has collected the sword from the Secret Sword Stash.</p>
                    
                    <p>The key design challenge was implementing the communication protocol between FSMs - the sword FSM monitors the current room to determine when to transition to the "has sword" state, while the room FSM checks sword possession to decide whether entering the Dragon Den leads to victory or death.</p>

                    <div class="tech-stack">
                        <span>SystemVerilog</span>
                        <span>Finite State Machines</span>
                        <span>Quartus Prime</span>
                        <span>RTL Design</span>
                        <span>Testbench Development</span>
                        <span>FPGA Synthesis</span>
                    </div>

                    <h2>Implementation Details</h2>
                    <p>The SystemVerilog implementation uses enumerated types for clear state definitions and follows standard FSM design patterns with separate always_ff and always_comb blocks. The room FSM responds to directional inputs (N, S, E, W) with appropriate state transitions based on the game map, while the sword FSM automatically transitions when the player reaches the Secret Sword Stash.</p>
                    
                    <div class="project-gallery two-items">
                        <div class="gallery-item">
                            <img src="../images/roomRTL.PNG" alt="Room FSM RTL">
                            <p>Room FSM synthesized hardware implementation</p>
                        </div>
                        <div class="gallery-item">
                            <img src="../images/swordRTL.PNG" alt="Sword FSM RTL">
                            <p>Sword FSM synthesized hardware implementation</p>
                        </div>
                    </div>

                    <h2>Verification and Testing</h2>
                    <p>I developed a comprehensive testbench with test vectors covering both winning and losing game scenarios. The winning path (E→S→W→E→E) demonstrates collecting the sword before facing the dragon, while the losing path (E→S→E→E) shows the consequences of entering the Dragon Den without the sword. The waveform analysis confirmed correct state transitions and FSM communication.</p>

                    <h2>SystemVerilog Implementation</h2>
                    <p>The complete SystemVerilog implementation demonstrates clean FSM design patterns and proper module hierarchy. The code is organized into separate modules for each FSM and a top-level module that instantiates and connects them.</p>
                    
                    <div class="tech-stack">
                        <span class="code-file-btn" data-file="sword_fsm">sword_fsm.sv</span>
                        <span class="code-file-btn" data-file="room_fsm">room_fsm.sv</span>
                        <span class="code-file-btn" data-file="adventure_game">adventure_game.sv</span>
                        <span class="code-file-btn" data-file="testbench">testbench.sv</span>
                        <span class="code-file-btn" data-file="testinputs">testinputs.tv</span>
                    </div>
                    
                    <div class="code-viewer" id="codeViewer">
                        <div class="code-header">
                            <span class="code-filename" id="codeFilename"></span>
                            <button class="code-close-btn" id="codeCloseBtn">×</button>
                        </div>
                        <pre class="code-content" id="codeContent"></pre>
                    </div>

                    <h2>Results</h2>
                    <p>The design successfully synthesized in Quartus and passed all verification tests. The RTL viewer confirmed the expected hardware implementation with proper state encoding and transition logic. This project provided valuable experience with digital design methodology, SystemVerilog coding practices, and FPGA development tools that formed the foundation for more complex digital systems projects.</p>

                    <div class="project-navigation">
                        <a href="../index.html" class="btn back-btn">Back to Projects</a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Mark Zbarsky</p>
            <div class="social-links">
                <a href="https://linkedin.com/in/mark-zbarsky-139697265/" target="_blank">LinkedIn</a>
                <a href="mailto:markzb1483@gmail.com">Email</a>
            </div>
        </div>
    </footer>
</body>
</html>